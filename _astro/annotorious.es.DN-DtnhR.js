import{r as un,R as fn}from"./index.Cn5qh0VW.js";var Fe={exports:{}},zt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var hn=un,pn=Symbol.for("react.element"),mn=Symbol.for("react.fragment"),gn=Object.prototype.hasOwnProperty,yn=hn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,$n={key:!0,ref:!0,__self:!0,__source:!0};function ze(t,e,n){var o,r={},i=null,s=null;n!==void 0&&(i=""+n),e.key!==void 0&&(i=""+e.key),e.ref!==void 0&&(s=e.ref);for(o in e)gn.call(e,o)&&!$n.hasOwnProperty(o)&&(r[o]=e[o]);if(t&&t.defaultProps)for(o in e=t.defaultProps,e)r[o]===void 0&&(r[o]=e[o]);return{$$typeof:pn,type:t,key:i,ref:s,props:r,_owner:yn.current}}zt.Fragment=mn;zt.jsx=ze;zt.jsxs=ze;Fe.exports=zt;var Vr=Fe.exports,qe={exports:{}},Lt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ye;function wn(){if(ye)return Lt;ye=1;var t=fn,e=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,r=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function s(a,l,c){var d,u={},p=null,h=null;c!==void 0&&(p=""+c),l.key!==void 0&&(p=""+l.key),l.ref!==void 0&&(h=l.ref);for(d in l)o.call(l,d)&&!i.hasOwnProperty(d)&&(u[d]=l[d]);if(a&&a.defaultProps)for(d in l=a.defaultProps,l)u[d]===void 0&&(u[d]=l[d]);return{$$typeof:e,type:a,key:p,ref:h,props:u,_owner:r.current}}return Lt.Fragment=n,Lt.jsx=s,Lt.jsxs=s,Lt}qe.exports=wn();var Dr=qe.exports,vn=[];for(var Kt=0;Kt<256;++Kt)vn.push((Kt+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const bn="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let xn=(t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t));for(;t--;)e+=bn[n[t]&63];return e};xn();var An=Object.defineProperty,En=(t,e,n)=>e in t?An(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,$e=(t,e,n)=>En(t,typeof e!="symbol"?e+"":e,n);function j(){}function ae(t,e){for(const n in e)t[n]=e[n];return t}function Ke(t){return t()}function we(){return Object.create(null)}function ut(t){t.forEach(Ke)}function F(t){return typeof t=="function"}function K(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Sn(t){return Object.keys(t).length===0}function We(t,...e){if(t==null){for(const o of e)o(void 0);return j}const n=t.subscribe(...e);return n.unsubscribe?()=>n.unsubscribe():n}function Wt(t,e,n){t.$$.on_destroy.push(We(e,n))}function Tn(t,e,n,o){if(t){const r=Je(t,e,n,o);return t[0](r)}}function Je(t,e,n,o){return t[1]&&o?ae(n.ctx.slice(),t[1](o(e))):n.ctx}function _n(t,e,n,o){if(t[2]&&o){const r=t[2](o(n));if(e.dirty===void 0)return r;if(typeof r=="object"){const i=[],s=Math.max(e.dirty.length,r.length);for(let a=0;a<s;a+=1)i[a]=e.dirty[a]|r[a];return i}return e.dirty|r}return e.dirty}function On(t,e,n,o,r,i){if(r){const s=Je(e,n,o,i);t.p(s,r)}}function Ln(t){if(t.ctx.length>32){const e=[],n=t.ctx.length/32;for(let o=0;o<n;o++)e[o]=-1;return e}return-1}function ve(t){const e={};for(const n in t)n[0]!=="$"&&(e[n]=t[n]);return e}function Ht(t){return t??""}const Bn=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function dt(t,e){t.appendChild(e)}function L(t,e,n){t.insertBefore(e,n||null)}function O(t){t.parentNode&&t.parentNode.removeChild(t)}function fe(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function P(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function Qe(t){return document.createTextNode(t)}function ot(){return Qe(" ")}function st(){return Qe("")}function H(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function f(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function Yn(t){return Array.from(t.childNodes)}function ht(t,e,n){t.classList.toggle(e,!!n)}function Mn(t,e,{bubbles:n=!1,cancelable:o=!1}={}){return new CustomEvent(t,{detail:e,bubbles:n,cancelable:o})}let kt;function Rt(t){kt=t}function Ze(){if(!kt)throw new Error("Function called outside component initialization");return kt}function Ct(t){Ze().$$.on_mount.push(t)}function St(){const t=Ze();return(e,n,{cancelable:o=!1}={})=>{const r=t.$$.callbacks[e];if(r){const i=Mn(e,n,{cancelable:o});return r.slice().forEach(s=>{s.call(t,i)}),!i.defaultPrevented}return!0}}function ft(t,e){const n=t.$$.callbacks[e.type];n&&n.slice().forEach(o=>o.call(this,e))}const bt=[],Ft=[];let At=[];const be=[],In=Promise.resolve();let le=!1;function Rn(){le||(le=!0,In.then(tn))}function ce(t){At.push(t)}const Jt=new Set;let yt=0;function tn(){if(yt!==0)return;const t=kt;do{try{for(;yt<bt.length;){const e=bt[yt];yt++,Rt(e),kn(e.$$)}}catch(e){throw bt.length=0,yt=0,e}for(Rt(null),bt.length=0,yt=0;Ft.length;)Ft.pop()();for(let e=0;e<At.length;e+=1){const n=At[e];Jt.has(n)||(Jt.add(n),n())}At.length=0}while(bt.length);for(;be.length;)be.pop()();le=!1,Jt.clear(),Rt(t)}function kn(t){if(t.fragment!==null){t.update(),ut(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(ce)}}function Cn(t){const e=[],n=[];At.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),At=e}const Gt=new Set;let pt;function rt(){pt={r:0,c:[],p:pt}}function it(){pt.r||ut(pt.c),pt=pt.p}function Y(t,e){t&&t.i&&(Gt.delete(t),t.i(e))}function C(t,e,n,o){if(t&&t.o){if(Gt.has(t))return;Gt.add(t),pt.c.push(()=>{Gt.delete(t),o&&(n&&t.d(1),o())}),t.o(e)}else o&&o()}function Et(t){return t?.length!==void 0?t:Array.from(t)}function tt(t){t&&t.c()}function J(t,e,n){const{fragment:o,after_update:r}=t.$$;o&&o.m(e,n),ce(()=>{const i=t.$$.on_mount.map(Ke).filter(F);t.$$.on_destroy?t.$$.on_destroy.push(...i):ut(i),t.$$.on_mount=[]}),r.forEach(ce)}function Q(t,e){const n=t.$$;n.fragment!==null&&(Cn(n.after_update),ut(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function Pn(t,e){t.$$.dirty[0]===-1&&(bt.push(t),Rn(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function et(t,e,n,o,r,i,s=null,a=[-1]){const l=kt;Rt(t);const c=t.$$={fragment:null,ctx:[],props:i,update:j,not_equal:r,bound:we(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:we(),dirty:a,skip_bound:!1,root:e.target||l.$$.root};s&&s(c.root);let d=!1;if(c.ctx=n?n(t,e.props||{},(u,p,...h)=>{const m=h.length?h[0]:p;return c.ctx&&r(c.ctx[u],c.ctx[u]=m)&&(!c.skip_bound&&c.bound[u]&&c.bound[u](m),d&&Pn(t,u)),p}):[],c.update(),d=!0,ut(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const u=Yn(e.target);c.fragment&&c.fragment.l(u),u.forEach(O)}else c.fragment&&c.fragment.c();e.intro&&Y(t.$$.fragment),J(t,e.target,e.anchor),tn()}Rt(l)}class nt{constructor(){$e(this,"$$"),$e(this,"$$set")}$destroy(){Q(this,1),this.$destroy=j}$on(e,n){if(!F(n))return j;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const r=o.indexOf(n);r!==-1&&o.splice(r,1)}}$set(e){this.$$set&&!Sn(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Nn="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Nn);var Z=(t=>(t.ELLIPSE="ELLIPSE",t.POLYGON="POLYGON",t.RECTANGLE="RECTANGLE",t))(Z||{});const he={},pe=(t,e)=>he[t]=e,de=t=>he[t.type].area(t),Vn=(t,e,n)=>he[t.type].intersects(t,e,n),ue=t=>{let e=1/0,n=1/0,o=-1/0,r=-1/0;return t.forEach(([i,s])=>{e=Math.min(e,i),n=Math.min(n,s),o=Math.max(o,i),r=Math.max(r,s)}),{minX:e,minY:n,maxX:o,maxY:r}},Dn={area:t=>Math.PI*t.geometry.rx*t.geometry.ry,intersects:(t,e,n)=>{const{cx:o,cy:r,rx:i,ry:s}=t.geometry,a=0,l=Math.cos(a),c=Math.sin(a),d=e-o,u=n-r,p=l*d+c*u,h=c*d-l*u;return p*p/(i*i)+h*h/(s*s)<=1}};pe(Z.ELLIPSE,Dn);const Un={area:t=>{const{points:e}=t.geometry;let n=0,o=e.length-1;for(let r=0;r<e.length;r++)n+=(e[o][0]+e[r][0])*(e[o][1]-e[r][1]),o=r;return Math.abs(.5*n)},intersects:(t,e,n)=>{const{points:o}=t.geometry;let r=!1;for(let i=0,s=o.length-1;i<o.length;s=i++){const a=o[i][0],l=o[i][1],c=o[s][0],d=o[s][1];l>n!=d>n&&e<(c-a)*(n-l)/(d-l)+a&&(r=!r)}return r}};pe(Z.POLYGON,Un);const Xn={area:t=>t.geometry.w*t.geometry.h,intersects:(t,e,n)=>e>=t.geometry.x&&e<=t.geometry.x+t.geometry.w&&n>=t.geometry.y&&n<=t.geometry.y+t.geometry.h};pe(Z.RECTANGLE,Xn);var z=[];for(var Qt=0;Qt<256;++Qt)z.push((Qt+256).toString(16).slice(1));function jn(t,e=0){return(z[t[e+0]]+z[t[e+1]]+z[t[e+2]]+z[t[e+3]]+"-"+z[t[e+4]]+z[t[e+5]]+"-"+z[t[e+6]]+z[t[e+7]]+"-"+z[t[e+8]]+z[t[e+9]]+"-"+z[t[e+10]]+z[t[e+11]]+z[t[e+12]]+z[t[e+13]]+z[t[e+14]]+z[t[e+15]]).toLowerCase()}var Ut,Gn=new Uint8Array(16);function Hn(){if(!Ut&&(Ut=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ut))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ut(Gn)}var Fn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const xe={randomUUID:Fn};function zn(t,e,n){if(xe.randomUUID&&!e&&!t)return xe.randomUUID();t=t||{};var o=t.random||(t.rng||Hn)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,jn(o)}var Ae=Object.prototype.hasOwnProperty;function mt(t,e){var n,o;if(t===e)return!0;if(t&&e&&(n=t.constructor)===e.constructor){if(n===Date)return t.getTime()===e.getTime();if(n===RegExp)return t.toString()===e.toString();if(n===Array){if((o=t.length)===e.length)for(;o--&&mt(t[o],e[o]););return o===-1}if(!n||typeof t=="object"){o=0;for(n in t)if(Ae.call(t,n)&&++o&&!Ae.call(e,n)||!(n in e)||!mt(t[n],e[n]))return!1;return Object.keys(e).length===o}}return t!==t&&e!==e}function Zt(){}function qn(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}const $t=[];function me(t,e=Zt){let n;const o=new Set;function r(a){if(qn(t,a)&&(t=a,n)){const l=!$t.length;for(const c of o)c[1](),$t.push(c,t);if(l){for(let c=0;c<$t.length;c+=2)$t[c][0]($t[c+1]);$t.length=0}}}function i(a){r(a(t))}function s(a,l=Zt){const c=[a,l];return o.add(c),o.size===1&&(n=e(r,i)||Zt),a(t),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:r,update:i,subscribe:s}}const Kn=t=>{const{subscribe:e,set:n}=me();let o;return e(r=>o=r),t.observe(({changes:r})=>{if(o){(r.deleted||[]).some(s=>s.id===o)&&n(void 0);const i=(r.updated||[]).find(({oldValue:s})=>s.id===o);i&&n(i.newValue.id)}}),{get current(){return o},subscribe:e,set:n}};var en=(t=>(t.EDIT="EDIT",t.SELECT="SELECT",t.NONE="NONE",t))(en||{});const te={selected:[]},Wn=(t,e="EDIT")=>{const{subscribe:n,set:o}=me(te);let r=e,i=te;n(h=>i=h);const s=()=>o(te),a=()=>{var h;return((h=i.selected)==null?void 0:h.length)===0},l=h=>{if(a())return!1;const m=typeof h=="string"?h:h.id;return i.selected.some(v=>v.id===m)},c=(h,m)=>{const v=t.getAnnotation(h);if(!v){console.warn("Invalid selection: "+h);return}switch(Ee(v,r)){case"EDIT":o({selected:[{id:h,editable:!0}],event:m});break;case"SELECT":o({selected:[{id:h}],event:m});break;default:o({selected:[],event:m})}},d=(h,m)=>{const v=Array.isArray(h)?h:[h],S=v.map(g=>t.getAnnotation(g)).filter(g=>!!g);o({selected:S.map(g=>{const $=m===void 0?Ee(g,r)==="EDIT":m;return{id:g.id,editable:$}})}),S.length!==v.length&&console.warn("Invalid selection",h)},u=h=>{if(a())return!1;const{selected:m}=i;m.some(({id:v})=>h.includes(v))&&o({selected:m.filter(({id:v})=>!h.includes(v))})},p=h=>r=h;return t.observe(({changes:h})=>u((h.deleted||[]).map(m=>m.id))),{get event(){return i?i.event:null},get selected(){return i?[...i.selected]:null},clear:s,isEmpty:a,isSelected:l,setSelected:d,setUserSelectAction:p,subscribe:n,userSelect:c}},Ee=(t,e)=>typeof e=="function"?e(t):e||"EDIT";var Jn=[];for(var ee=0;ee<256;++ee)Jn.push((ee+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Qn=(t,e)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},Zn=(t,e)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},to=(t,e)=>e.bodies.map(n=>{const o=t.bodies.find(r=>r.id===n.id);return{newBody:n,oldBody:o&&!mt(o,n)?o:void 0}}).filter(({oldBody:n})=>n).map(({oldBody:n,newBody:o})=>({oldBody:n,newBody:o})),eo=(t,e)=>!mt(t.target,e.target),nn=(t,e)=>{const n=Qn(t,e),o=Zn(t,e),r=to(t,e);return{oldValue:t,newValue:e,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:r.length>0?r:void 0,targetUpdated:eo(t,e)?{oldTarget:t.target,newTarget:e.target}:void 0}};var X=(t=>(t.LOCAL="LOCAL",t.REMOTE="REMOTE",t))(X||{});const no=(t,e)=>{var n,o;const{changes:r,origin:i}=e;if(!(!t.options.origin||t.options.origin===i))return!1;if(t.options.ignore){const{ignore:s}=t.options,a=l=>l&&l.length>0;if(!(a(r.created)||a(r.deleted))){const l=(n=r.updated)==null?void 0:n.some(d=>a(d.bodiesCreated)||a(d.bodiesDeleted)||a(d.bodiesUpdated)),c=(o=r.updated)==null?void 0:o.some(d=>d.targetUpdated);if(s==="BODY_ONLY"&&l&&!c||s==="TARGET_ONLY"&&c&&!l)return!1}}if(t.options.annotations){const s=new Set([...(r.created||[]).map(a=>a.id),...(r.deleted||[]).map(a=>a.id),...(r.updated||[]).map(({oldValue:a})=>a.id)]);return!!(Array.isArray(t.options.annotations)?t.options.annotations:[t.options.annotations]).find(a=>s.has(a))}else return!0},oo=(t,e)=>{const n=new Set((t.created||[]).map(u=>u.id)),o=new Set((t.updated||[]).map(({newValue:u})=>u.id)),r=new Set((e.created||[]).map(u=>u.id)),i=new Set((e.deleted||[]).map(u=>u.id)),s=new Set((e.updated||[]).map(({oldValue:u})=>u.id)),a=new Set((e.updated||[]).filter(({oldValue:u})=>n.has(u.id)||o.has(u.id)).map(({oldValue:u})=>u.id)),l=[...(t.created||[]).filter(u=>!i.has(u.id)).map(u=>s.has(u.id)?e.updated.find(({oldValue:p})=>p.id===u.id).newValue:u),...e.created||[]],c=[...(t.deleted||[]).filter(u=>!r.has(u.id)),...(e.deleted||[]).filter(u=>!n.has(u.id))],d=[...(t.updated||[]).filter(({newValue:u})=>!i.has(u.id)).map(u=>{const{oldValue:p,newValue:h}=u;if(s.has(h.id)){const m=e.updated.find(v=>v.oldValue.id===h.id).newValue;return nn(p,m)}else return u}),...(e.updated||[]).filter(({oldValue:u})=>!a.has(u.id))];return{created:l,deleted:c,updated:d}},ro=t=>t.id!==void 0,io=()=>{const t=new Map,e=new Map,n=[],o=(b,x={})=>n.push({onChange:b,options:x}),r=b=>{const x=n.findIndex(A=>A.onChange==b);x>-1&&n.splice(x,1)},i=(b,x)=>{const A={origin:b,changes:{created:x.created||[],updated:x.updated||[],deleted:x.deleted||[]},state:[...t.values()]};n.forEach(E=>{no(E,A)&&E.onChange(A)})},s=(b,x=X.LOCAL)=>{if(t.get(b.id))throw Error(`Cannot add annotation ${b.id} - exists already`);t.set(b.id,b),b.bodies.forEach(A=>e.set(A.id,b.id)),i(x,{created:[b]})},a=(b,x)=>{const A=typeof b=="string"?x:b,E=typeof b=="string"?b:b.id,I=t.get(E);if(I){const N=nn(I,A);return E===A.id?t.set(E,A):(t.delete(E),t.set(A.id,A)),I.bodies.forEach(W=>e.delete(W.id)),A.bodies.forEach(W=>e.set(W.id,A.id)),N}else console.warn(`Cannot update annotation ${E} - does not exist`)},l=(b,x=X.LOCAL,A=X.LOCAL)=>{const E=ro(x)?A:x,I=a(b,x);I&&i(E,{updated:[I]})},c=(b,x=X.LOCAL)=>{const A=b.reduce((E,I)=>{const N=a(I);return N?[...E,N]:E},[]);A.length>0&&i(x,{updated:A})},d=(b,x=X.LOCAL)=>{const A=t.get(b.annotation);if(A){const E={...A,bodies:[...A.bodies,b]};t.set(A.id,E),e.set(b.id,E.id),i(x,{updated:[{oldValue:A,newValue:E,bodiesCreated:[b]}]})}else console.warn(`Attempt to add body to missing annotation: ${b.annotation}`)},u=()=>[...t.values()],p=(b=X.LOCAL)=>{const x=[...t.values()];t.clear(),e.clear(),i(b,{deleted:x})},h=(b,x=!0,A=X.LOCAL)=>{if(x){const E=[...t.values()];t.clear(),e.clear(),b.forEach(I=>{t.set(I.id,I),I.bodies.forEach(N=>e.set(N.id,I.id))}),i(A,{created:b,deleted:E})}else{const E=b.reduce((I,N)=>{const W=t.get(N.id);return W?[...I,W]:I},[]);if(E.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${E.map(I=>I.id).join(", ")}`);b.forEach(I=>{t.set(I.id,I),I.bodies.forEach(N=>e.set(N.id,I.id))}),i(A,{created:b})}},m=b=>{const x=typeof b=="string"?b:b.id,A=t.get(x);if(A)return t.delete(x),A.bodies.forEach(E=>e.delete(E.id)),A;console.warn(`Attempt to delete missing annotation: ${x}`)},v=(b,x=X.LOCAL)=>{const A=m(b);A&&i(x,{deleted:[A]})},S=(b,x=X.LOCAL)=>{const A=b.reduce((E,I)=>{const N=m(I);return N?[...E,N]:E},[]);A.length>0&&i(x,{deleted:A})},g=b=>{const x=t.get(b.annotation);if(x){const A=x.bodies.find(E=>E.id===b.id);if(A){e.delete(A.id);const E={...x,bodies:x.bodies.filter(I=>I.id!==b.id)};return t.set(x.id,E),{oldValue:x,newValue:E,bodiesDeleted:[A]}}else console.warn(`Attempt to delete missing body ${b.id} from annotation ${b.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${b.annotation}`)},$=(b,x=X.LOCAL)=>{const A=g(b);A&&i(x,{updated:[A]})},y=(b,x=X.LOCAL)=>{const A=b.map(E=>g(E)).filter(Boolean);A.length>0&&i(x,{updated:A})},w=b=>{const x=t.get(b);return x?{...x}:void 0},k=b=>{const x=e.get(b);if(x){const A=w(x).bodies.find(E=>E.id===b);if(A)return A;console.error(`Store integrity error: body ${b} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${b}`)},V=(b,x)=>{if(b.annotation!==x.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const A=t.get(b.annotation);if(A){const E=A.bodies.find(N=>N.id===b.id),I={...A,bodies:A.bodies.map(N=>N.id===E.id?x:N)};return t.set(A.id,I),E.id!==x.id&&(e.delete(E.id),e.set(x.id,I.id)),{oldValue:A,newValue:I,bodiesUpdated:[{oldBody:E,newBody:x}]}}else console.warn(`Attempt to add body to missing annotation ${b.annotation}`)},D=(b,x,A=X.LOCAL)=>{const E=V(b,x);E&&i(A,{updated:[E]})},U=(b,x=X.LOCAL)=>{const A=b.map(E=>V({id:E.id,annotation:E.annotation},E)).filter(Boolean);i(x,{updated:A})},M=b=>{const x=t.get(b.annotation);if(x){const A={...x,target:{...x.target,...b}};return t.set(x.id,A),{oldValue:x,newValue:A,targetUpdated:{oldTarget:x.target,newTarget:b}}}else console.warn(`Attempt to update target on missing annotation: ${b.annotation}`)};return{addAnnotation:s,addBody:d,all:u,bulkAddAnnotation:h,bulkDeleteAnnotation:S,bulkDeleteBodies:y,bulkUpdateAnnotation:c,bulkUpdateBodies:U,bulkUpdateTargets:(b,x=X.LOCAL)=>{const A=b.map(E=>M(E)).filter(Boolean);A.length>0&&i(x,{updated:A})},clear:p,deleteAnnotation:v,deleteBody:$,getAnnotation:w,getBody:k,observe:o,unobserve:r,updateAnnotation:l,updateBody:D,updateTarget:(b,x=X.LOCAL)=>{const A=M(b);A&&i(x,{updated:[A]})}}},so=t=>({...t,subscribe:e=>{const n=o=>e(o.state);return t.observe(n),e(t.all()),()=>t.unobserve(n)}});let ao=()=>({emit(t,...e){for(let n=0,o=this.events[t]||[],r=o.length;n<r;n++)o[n](...e)},events:{},on(t,e){var n;return((n=this.events)[t]||(n[t]=[])).push(e),()=>{var o;this.events[t]=(o=this.events[t])==null?void 0:o.filter(r=>e!==r)}}});const lo=250,co=t=>{const e=ao(),n=[];let o=-1,r=!1,i=0;const s=h=>{if(!r){const{changes:m}=h,v=performance.now();if(v-i>lo)n.splice(o+1),n.push(m),o=n.length-1;else{const S=n.length-1;n[S]=oo(n[S],m)}i=v}r=!1};t.observe(s,{origin:X.LOCAL});const a=h=>h&&h.length>0&&t.bulkDeleteAnnotation(h),l=h=>h&&h.length>0&&t.bulkAddAnnotation(h,!1),c=h=>h&&h.length>0&&t.bulkUpdateAnnotation(h.map(({oldValue:m})=>m)),d=h=>h&&h.length>0&&t.bulkUpdateAnnotation(h.map(({newValue:m})=>m)),u=h=>h&&h.length>0&&t.bulkAddAnnotation(h,!1),p=h=>h&&h.length>0&&t.bulkDeleteAnnotation(h);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>t.unobserve(s),on:(h,m)=>e.on(h,m),redo:()=>{if(n.length-1>o){r=!0;const{created:h,updated:m,deleted:v}=n[o+1];l(h),d(m),p(v),e.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){r=!0;const{created:h,updated:m,deleted:v}=n[o];a(h),c(m),u(v),e.emit("undo",n[o]),o-=1}}}},uo=()=>{const{subscribe:t,set:e}=me([]);return{subscribe:t,set:e}},fo=(t,e,n,o)=>{const{store:r,selection:i,hover:s,viewport:a}=t,l=new Map;let c=[],d,u;const p=(g,$)=>{l.has(g)?l.get(g).push($):l.set(g,[$])},h=(g,$)=>{const y=l.get(g);if(y){const w=y.indexOf($);w!==-1&&y.splice(w,1)}},m=(g,$,y)=>{l.has(g)&&setTimeout(()=>{l.get(g).forEach(w=>{if(n){const k=Array.isArray($)?$.map(D=>n.serialize(D)):n.serialize($),V=y?y instanceof PointerEvent?y:n.serialize(y):void 0;w(k,V)}else w($,y)})},1)},v=()=>{const{selected:g}=i,$=(g||[]).map(({id:y})=>r.getAnnotation(y));$.forEach(y=>{const w=c.find(k=>k.id===y.id);(!w||!mt(w,y))&&m("updateAnnotation",y,w)}),c=c.map(y=>$.find(({id:w})=>w===y.id)||y)};i.subscribe(({selected:g})=>{if(!(c.length===0&&g.length===0)){if(c.length===0&&g.length>0)c=g.map(({id:$})=>r.getAnnotation($));else if(c.length>0&&g.length===0)c.forEach($=>{const y=r.getAnnotation($.id);y&&!mt(y,$)&&m("updateAnnotation",y,$)}),c=[];else{const $=new Set(c.map(w=>w.id)),y=new Set(g.map(({id:w})=>w));c.filter(w=>!y.has(w.id)).forEach(w=>{const k=r.getAnnotation(w.id);k&&!mt(k,w)&&m("updateAnnotation",k,w)}),c=[...c.filter(w=>y.has(w.id)),...g.filter(({id:w})=>!$.has(w)).map(({id:w})=>r.getAnnotation(w))]}m("selectionChanged",c)}}),s.subscribe(g=>{!d&&g?m("mouseEnterAnnotation",r.getAnnotation(g)):d&&!g?m("mouseLeaveAnnotation",r.getAnnotation(d)):d&&g&&(m("mouseLeaveAnnotation",r.getAnnotation(d)),m("mouseEnterAnnotation",r.getAnnotation(g))),d=g}),a?.subscribe(g=>m("viewportIntersect",g.map($=>r.getAnnotation($)))),r.observe(g=>{o&&(u&&clearTimeout(u),u=setTimeout(v,1e3));const{created:$,deleted:y}=g.changes;($||[]).forEach(w=>m("createAnnotation",w)),(y||[]).forEach(w=>m("deleteAnnotation",w)),(g.changes.updated||[]).filter(w=>[...w.bodiesCreated||[],...w.bodiesDeleted||[],...w.bodiesUpdated||[]].length>0).forEach(({oldValue:w,newValue:k})=>{const V=c.find(D=>D.id===w.id)||w;c=c.map(D=>D.id===w.id?k:D),m("updateAnnotation",k,V)})},{origin:X.LOCAL}),r.observe(g=>{if(c){const $=new Set(c.map(w=>w.id)),y=(g.changes.updated||[]).filter(({newValue:w})=>$.has(w.id)).map(({newValue:w})=>w);y.length>0&&(c=c.map(w=>y.find(k=>k.id===w.id)||w))}},{origin:X.REMOTE});const S=g=>$=>{const{updated:y}=$;g?(y||[]).forEach(w=>m("updateAnnotation",w.oldValue,w.newValue)):(y||[]).forEach(w=>m("updateAnnotation",w.newValue,w.oldValue))};return e.on("undo",S(!0)),e.on("redo",S(!1)),{on:p,off:h,emit:m}},ho=t=>e=>e.reduce((n,o)=>{const{parsed:r,error:i}=t.parse(o);return i?{parsed:n.parsed,failed:[...n.failed,o]}:r?{parsed:[...n.parsed,r],failed:n.failed}:{...n}},{parsed:[],failed:[]}),po=(t,e,n)=>{const{store:o,selection:r}=t,i=g=>{if(n){const{parsed:$,error:y}=n.parse(g);$?o.addAnnotation($,X.REMOTE):console.error(y)}else o.addAnnotation(g,X.REMOTE)},s=()=>r.clear(),a=()=>o.clear(),l=g=>{const $=o.getAnnotation(g);return n&&$?n.serialize($):$},c=()=>n?o.all().map(n.serialize):o.all(),d=()=>{var g;const $=(((g=r.selected)==null?void 0:g.map(y=>y.id))||[]).map(y=>o.getAnnotation(y)).filter(Boolean);return n?$.map(n.serialize):$},u=(g,$=!0)=>fetch(g).then(y=>y.json()).then(y=>(h(y,$),y)),p=g=>{if(typeof g=="string"){const $=o.getAnnotation(g);if(o.deleteAnnotation(g),$)return n?n.serialize($):$}else{const $=n?n.parse(g).parsed:g;if($)return o.deleteAnnotation($),g}},h=(g,$=!0)=>{if(n){const{parsed:y,failed:w}=ho(n)(g);w.length>0&&console.warn(`Discarded ${w.length} invalid annotations`,w),o.bulkAddAnnotation(y,$,X.REMOTE)}else o.bulkAddAnnotation(g,$,X.REMOTE)},m=(g,$)=>{g?r.setSelected(g,$):r.clear()},v=g=>{r.clear(),r.setUserSelectAction(g)},S=g=>{if(n){const $=n.parse(g).parsed,y=n.serialize(o.getAnnotation($.id));return o.updateAnnotation($),y}else{const $=o.getAnnotation(g.id);return o.updateAnnotation(g),$}};return{addAnnotation:i,cancelSelected:s,canRedo:e.canRedo,canUndo:e.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:c,getSelected:d,loadAnnotations:u,redo:e.redo,removeAnnotation:p,setAnnotations:h,setSelected:m,setUserSelectAction:v,undo:e.undo,updateAnnotation:S}},mo="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let go=t=>crypto.getRandomValues(new Uint8Array(t)),yo=(t,e,n)=>{let o=(2<<Math.log(t.length-1)/Math.LN2)-1,r=-~(1.6*o*e/t.length);return(i=e)=>{let s="";for(;;){let a=n(r),l=r;for(;l--;)if(s+=t[a[l]&o]||"",s.length===i)return s}}},$o=(t,e=21)=>yo(t,e,go),wo=(t=21)=>{let e="",n=crypto.getRandomValues(new Uint8Array(t));for(;t--;)e+=mo[n[t]&63];return e};const vo=()=>({isGuest:!0,id:$o("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()});wo();function Se(t,e,n){const o=t.slice();return o[10]=e[n],o[12]=n,o}function Te(t){let e,n;return e=new Yt({props:{x:t[10][0],y:t[10][1],scale:t[3]}}),e.$on("pointerdown",function(){F(t[9](`HANDLE-${t[12]}`))&&t[9](`HANDLE-${t[12]}`).apply(this,arguments)}),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,r){t=o;const i={};r&16&&(i.x=t[10][0]),r&16&&(i.y=t[10][1]),r&8&&(i.scale=t[3]),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}function bo(t){let e,n,o,r,i,s,a,l,c,d,u,p=Et(t[4].points),h=[];for(let v=0;v<p.length;v+=1)h[v]=Te(Se(t,p,v));const m=v=>C(h[v],1,1,()=>{h[v]=null});return{c(){e=P("polygon"),r=ot(),i=P("polygon"),a=ot();for(let v=0;v<h.length;v+=1)h[v].c();l=st(),f(e,"class","a9s-outer"),f(e,"style",n=t[1]?"display:none;":void 0),f(e,"points",o=t[4].points.map(_e).join(" ")),f(i,"class","a9s-inner a9s-shape-handle"),f(i,"style",t[1]),f(i,"points",s=t[4].points.map(Oe).join(" "))},m(v,S){L(v,e,S),L(v,r,S),L(v,i,S),L(v,a,S);for(let g=0;g<h.length;g+=1)h[g]&&h[g].m(v,S);L(v,l,S),c=!0,d||(u=[H(e,"pointerdown",function(){F(t[9]("SHAPE"))&&t[9]("SHAPE").apply(this,arguments)}),H(i,"pointerdown",function(){F(t[9]("SHAPE"))&&t[9]("SHAPE").apply(this,arguments)})],d=!0)},p(v,S){if(t=v,(!c||S&2&&n!==(n=t[1]?"display:none;":void 0))&&f(e,"style",n),(!c||S&16&&o!==(o=t[4].points.map(_e).join(" ")))&&f(e,"points",o),(!c||S&2)&&f(i,"style",t[1]),(!c||S&16&&s!==(s=t[4].points.map(Oe).join(" ")))&&f(i,"points",s),S&536){p=Et(t[4].points);let g;for(g=0;g<p.length;g+=1){const $=Se(t,p,g);h[g]?(h[g].p($,S),Y(h[g],1)):(h[g]=Te($),h[g].c(),Y(h[g],1),h[g].m(l.parentNode,l))}for(rt(),g=p.length;g<h.length;g+=1)m(g);it()}},i(v){if(!c){for(let S=0;S<p.length;S+=1)Y(h[S]);c=!0}},o(v){h=h.filter(Boolean);for(let S=0;S<h.length;S+=1)C(h[S]);c=!1},d(v){v&&(O(e),O(r),O(i),O(a),O(l)),fe(h,v),d=!1,ut(u)}}}function xo(t){let e,n;return e=new rn({props:{shape:t[0],transform:t[2],editor:t[5],$$slots:{default:[bo,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:t}}}),e.$on("change",t[6]),e.$on("grab",t[7]),e.$on("release",t[8]),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,[r]){const i={};r&1&&(i.shape=o[0]),r&4&&(i.transform=o[2]),r&8730&&(i.$$scope={dirty:r,ctx:o}),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}const _e=t=>t.join(","),Oe=t=>t.join(",");function Ao(t,e,n){let o,{shape:r}=e,{computedStyle:i}=e,{transform:s}=e,{viewportScale:a=1}=e;const l=(p,h,m)=>{let v;const S=p.geometry;h==="SHAPE"?v=S.points.map(([$,y])=>[$+m[0],y+m[1]]):v=S.points.map(([$,y],w)=>h===`HANDLE-${w}`?[$+m[0],y+m[1]]:[$,y]);const g=ue(v);return{...p,geometry:{points:v,bounds:g}}};function c(p){ft.call(this,t,p)}function d(p){ft.call(this,t,p)}function u(p){ft.call(this,t,p)}return t.$$set=p=>{"shape"in p&&n(0,r=p.shape),"computedStyle"in p&&n(1,i=p.computedStyle),"transform"in p&&n(2,s=p.transform),"viewportScale"in p&&n(3,a=p.viewportScale)},t.$$.update=()=>{t.$$.dirty&1&&n(4,o=r.geometry)},[r,i,s,a,o,l,c,d,u]}class Eo extends nt{constructor(e){super(),et(this,e,Ao,xo,K,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}const ne=(t,e)=>{const n=Math.abs(e[0]-t[0]),o=Math.abs(e[1]-t[1]);return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},wt=[];function So(t,e=j){let n;const o=new Set;function r(a){if(K(t,a)&&(t=a,n)){const l=!wt.length;for(const c of o)c[1](),wt.push(c,t);if(l){for(let c=0;c<wt.length;c+=2)wt[c][0](wt[c+1]);wt.length=0}}}function i(a){r(a(t))}function s(a,l=j){const c=[a,l];return o.add(c),o.size===1&&(n=e(r,i)||j),a(t),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:r,update:i,subscribe:s}}const To=(t,e)=>{const{naturalWidth:n,naturalHeight:o}=t;if(!n&&!o){const{width:r,height:i}=t;e.setAttribute("viewBox",`0 0 ${r} ${i}`),t.addEventListener("load",s=>{const a=s.target;e.setAttribute("viewBox",`0 0 ${a.naturalWidth} ${a.naturalHeight}`)})}else e.setAttribute("viewBox",`0 0 ${n} ${o}`)},_o=(t,e)=>{To(t,e);const{subscribe:n,set:o}=So(1);let r;return window.ResizeObserver&&(r=new ResizeObserver(()=>{const i=e.getBoundingClientRect(),{width:s,height:a}=e.viewBox.baseVal,l=Math.max(i.width/s,i.height/a);o(l)}),r.observe(e.parentElement)),{destroy:()=>{r&&r.disconnect()},subscribe:n}},Oo="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;function Lo(t){let e,n,o,r,i,s;return{c(){e=P("rect"),f(e,"class",n=Ht(`a9s-handle ${t[8].class||""}`.trim())+" svelte-1sgkh33"),f(e,"x",o=t[0]-t[5]/2),f(e,"y",r=t[1]-t[5]/2),f(e,"width",t[5]),f(e,"height",t[5])},m(a,l){L(a,e,l),i||(s=H(e,"pointerdown",t[11]),i=!0)},p(a,l){l&256&&n!==(n=Ht(`a9s-handle ${a[8].class||""}`.trim())+" svelte-1sgkh33")&&f(e,"class",n),l&33&&o!==(o=a[0]-a[5]/2)&&f(e,"x",o),l&34&&r!==(r=a[1]-a[5]/2)&&f(e,"y",r),l&32&&f(e,"width",a[5]),l&32&&f(e,"height",a[5])},d(a){a&&O(e),i=!1,s()}}}function Bo(t){let e,n,o,r,i,s,a,l,c;return{c(){e=P("g"),n=P("circle"),r=P("rect"),f(n,"cx",t[0]),f(n,"cy",t[1]),f(n,"r",o=t[3]/t[2]),f(n,"class","a9s-touch-halo svelte-1sgkh33"),ht(n,"touched",t[4]),f(r,"class",i=Ht(`a9s-handle ${t[8].class||""}`.trim())+" svelte-1sgkh33"),f(r,"x",s=t[0]-t[5]/2),f(r,"y",a=t[1]-t[5]/2),f(r,"width",t[5]),f(r,"height",t[5]),f(e,"class","a9s-touch-handle")},m(d,u){L(d,e,u),dt(e,n),dt(e,r),l||(c=[H(n,"pointerdown",t[10]),H(n,"pointerdown",t[6]),H(n,"pointerup",t[7]),H(r,"pointerdown",t[9]),H(r,"pointerdown",t[6]),H(r,"pointerup",t[7])],l=!0)},p(d,u){u&1&&f(n,"cx",d[0]),u&2&&f(n,"cy",d[1]),u&12&&o!==(o=d[3]/d[2])&&f(n,"r",o),u&16&&ht(n,"touched",d[4]),u&256&&i!==(i=Ht(`a9s-handle ${d[8].class||""}`.trim())+" svelte-1sgkh33")&&f(r,"class",i),u&33&&s!==(s=d[0]-d[5]/2)&&f(r,"x",s),u&34&&a!==(a=d[1]-d[5]/2)&&f(r,"y",a),u&32&&f(r,"width",d[5]),u&32&&f(r,"height",d[5])},d(d){d&&O(e),l=!1,ut(c)}}}function Yo(t){let e;function n(r,i){return Oo?Bo:Lo}let o=n()(t);return{c(){o.c(),e=st()},m(r,i){o.m(r,i),L(r,e,i)},p(r,[i]){o.p(r,i)},i:j,o:j,d(r){r&&O(e),o.d(r)}}}function Mo(t,e,n){let o,{x:r}=e,{y:i}=e,{scale:s}=e,{radius:a=30}=e,l=!1;const c=m=>{m.pointerType==="touch"&&n(4,l=!0)},d=()=>n(4,l=!1);function u(m){ft.call(this,t,m)}function p(m){ft.call(this,t,m)}function h(m){ft.call(this,t,m)}return t.$$set=m=>{n(8,e=ae(ae({},e),ve(m))),"x"in m&&n(0,r=m.x),"y"in m&&n(1,i=m.y),"scale"in m&&n(2,s=m.scale),"radius"in m&&n(3,a=m.radius)},t.$$.update=()=>{t.$$.dirty&4&&n(5,o=10/s)},e=ve(e),[r,i,s,a,l,o,c,d,e,u,p,h]}class Yt extends nt{constructor(e){super(),et(this,e,Mo,Yo,K,{x:0,y:1,scale:2,radius:3})}}function Io(t){let e,n,o,r,i,s,a,l,c,d,u,p,h,m,v,S,g,$,y,w,k,V,D,U,M,b,x,A,E,I,N,W,Tt,at,_t,lt,Ot,ct,_,G,B,q,gt;return at=new Yt({props:{class:"a9s-corner-handle-topleft",x:t[4].x,y:t[4].y,scale:t[3]}}),at.$on("pointerdown",function(){F(t[9]("TOP_LEFT"))&&t[9]("TOP_LEFT").apply(this,arguments)}),lt=new Yt({props:{class:"a9s-corner-handle-topright",x:t[4].x+t[4].w,y:t[4].y,scale:t[3]}}),lt.$on("pointerdown",function(){F(t[9]("TOP_RIGHT"))&&t[9]("TOP_RIGHT").apply(this,arguments)}),ct=new Yt({props:{class:"a9s-corner-handle-bottomright",x:t[4].x+t[4].w,y:t[4].y+t[4].h,scale:t[3]}}),ct.$on("pointerdown",function(){F(t[9]("BOTTOM_RIGHT"))&&t[9]("BOTTOM_RIGHT").apply(this,arguments)}),G=new Yt({props:{class:"a9s-corner-handle-bottomleft",x:t[4].x,y:t[4].y+t[4].h,scale:t[3]}}),G.$on("pointerdown",function(){F(t[9]("BOTTOM_LEFT"))&&t[9]("BOTTOM_LEFT").apply(this,arguments)}),{c(){e=P("rect"),a=ot(),l=P("rect"),h=ot(),m=P("rect"),$=ot(),y=P("rect"),D=ot(),U=P("rect"),A=ot(),E=P("rect"),Tt=ot(),tt(at.$$.fragment),_t=ot(),tt(lt.$$.fragment),Ot=ot(),tt(ct.$$.fragment),_=ot(),tt(G.$$.fragment),f(e,"class","a9s-outer"),f(e,"style",n=t[1]?"display:none;":void 0),f(e,"x",o=t[4].x),f(e,"y",r=t[4].y),f(e,"width",i=t[4].w),f(e,"height",s=t[4].h),f(l,"class","a9s-inner a9s-shape-handle"),f(l,"style",t[1]),f(l,"x",c=t[4].x),f(l,"y",d=t[4].y),f(l,"width",u=t[4].w),f(l,"height",p=t[4].h),f(m,"class","a9s-edge-handle a9s-edge-handle-top"),f(m,"x",v=t[4].x),f(m,"y",S=t[4].y),f(m,"height",1),f(m,"width",g=t[4].w),f(y,"class","a9s-edge-handle a9s-edge-handle-right"),f(y,"x",w=t[4].x+t[4].w),f(y,"y",k=t[4].y),f(y,"height",V=t[4].h),f(y,"width",1),f(U,"class","a9s-edge-handle a9s-edge-handle-bottom"),f(U,"x",M=t[4].x),f(U,"y",b=t[4].y+t[4].h),f(U,"height",1),f(U,"width",x=t[4].w),f(E,"class","a9s-edge-handle a9s-edge-handle-left"),f(E,"x",I=t[4].x),f(E,"y",N=t[4].y),f(E,"height",W=t[4].h),f(E,"width",1)},m(R,T){L(R,e,T),L(R,a,T),L(R,l,T),L(R,h,T),L(R,m,T),L(R,$,T),L(R,y,T),L(R,D,T),L(R,U,T),L(R,A,T),L(R,E,T),L(R,Tt,T),J(at,R,T),L(R,_t,T),J(lt,R,T),L(R,Ot,T),J(ct,R,T),L(R,_,T),J(G,R,T),B=!0,q||(gt=[H(e,"pointerdown",function(){F(t[9]("SHAPE"))&&t[9]("SHAPE").apply(this,arguments)}),H(l,"pointerdown",function(){F(t[9]("SHAPE"))&&t[9]("SHAPE").apply(this,arguments)}),H(m,"pointerdown",function(){F(t[9]("TOP"))&&t[9]("TOP").apply(this,arguments)}),H(y,"pointerdown",function(){F(t[9]("RIGHT"))&&t[9]("RIGHT").apply(this,arguments)}),H(U,"pointerdown",function(){F(t[9]("BOTTOM"))&&t[9]("BOTTOM").apply(this,arguments)}),H(E,"pointerdown",function(){F(t[9]("LEFT"))&&t[9]("LEFT").apply(this,arguments)})],q=!0)},p(R,T){t=R,(!B||T&2&&n!==(n=t[1]?"display:none;":void 0))&&f(e,"style",n),(!B||T&16&&o!==(o=t[4].x))&&f(e,"x",o),(!B||T&16&&r!==(r=t[4].y))&&f(e,"y",r),(!B||T&16&&i!==(i=t[4].w))&&f(e,"width",i),(!B||T&16&&s!==(s=t[4].h))&&f(e,"height",s),(!B||T&2)&&f(l,"style",t[1]),(!B||T&16&&c!==(c=t[4].x))&&f(l,"x",c),(!B||T&16&&d!==(d=t[4].y))&&f(l,"y",d),(!B||T&16&&u!==(u=t[4].w))&&f(l,"width",u),(!B||T&16&&p!==(p=t[4].h))&&f(l,"height",p),(!B||T&16&&v!==(v=t[4].x))&&f(m,"x",v),(!B||T&16&&S!==(S=t[4].y))&&f(m,"y",S),(!B||T&16&&g!==(g=t[4].w))&&f(m,"width",g),(!B||T&16&&w!==(w=t[4].x+t[4].w))&&f(y,"x",w),(!B||T&16&&k!==(k=t[4].y))&&f(y,"y",k),(!B||T&16&&V!==(V=t[4].h))&&f(y,"height",V),(!B||T&16&&M!==(M=t[4].x))&&f(U,"x",M),(!B||T&16&&b!==(b=t[4].y+t[4].h))&&f(U,"y",b),(!B||T&16&&x!==(x=t[4].w))&&f(U,"width",x),(!B||T&16&&I!==(I=t[4].x))&&f(E,"x",I),(!B||T&16&&N!==(N=t[4].y))&&f(E,"y",N),(!B||T&16&&W!==(W=t[4].h))&&f(E,"height",W);const Pt={};T&16&&(Pt.x=t[4].x),T&16&&(Pt.y=t[4].y),T&8&&(Pt.scale=t[3]),at.$set(Pt);const Nt={};T&16&&(Nt.x=t[4].x+t[4].w),T&16&&(Nt.y=t[4].y),T&8&&(Nt.scale=t[3]),lt.$set(Nt);const Vt={};T&16&&(Vt.x=t[4].x+t[4].w),T&16&&(Vt.y=t[4].y+t[4].h),T&8&&(Vt.scale=t[3]),ct.$set(Vt);const Dt={};T&16&&(Dt.x=t[4].x),T&16&&(Dt.y=t[4].y+t[4].h),T&8&&(Dt.scale=t[3]),G.$set(Dt)},i(R){B||(Y(at.$$.fragment,R),Y(lt.$$.fragment,R),Y(ct.$$.fragment,R),Y(G.$$.fragment,R),B=!0)},o(R){C(at.$$.fragment,R),C(lt.$$.fragment,R),C(ct.$$.fragment,R),C(G.$$.fragment,R),B=!1},d(R){R&&(O(e),O(a),O(l),O(h),O(m),O($),O(y),O(D),O(U),O(A),O(E),O(Tt),O(_t),O(Ot),O(_)),Q(at,R),Q(lt,R),Q(ct,R),Q(G,R),q=!1,ut(gt)}}}function Ro(t){let e,n;return e=new rn({props:{shape:t[0],transform:t[2],editor:t[5],$$slots:{default:[Io,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:t}}}),e.$on("grab",t[6]),e.$on("change",t[7]),e.$on("release",t[8]),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,[r]){const i={};r&1&&(i.shape=o[0]),r&4&&(i.transform=o[2]),r&1562&&(i.$$scope={dirty:r,ctx:o}),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}function ko(t,e,n){let o,{shape:r}=e,{computedStyle:i}=e,{transform:s}=e,{viewportScale:a=1}=e;const l=(p,h,m)=>{const v=p.geometry.bounds;let[S,g]=[v.minX,v.minY],[$,y]=[v.maxX,v.maxY];const[w,k]=m;if(h==="SHAPE")S+=w,$+=w,g+=k,y+=k;else{switch(h){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":{g+=k;break}case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":{y+=k;break}}switch(h){case"LEFT":case"TOP_LEFT":case"BOTTOM_LEFT":{S+=w;break}case"RIGHT":case"TOP_RIGHT":case"BOTTOM_RIGHT":{$+=w;break}}}const V=Math.min(S,$),D=Math.min(g,y),U=Math.abs($-S),M=Math.abs(y-g);return{...p,geometry:{x:V,y:D,w:U,h:M,bounds:{minX:V,minY:D,maxX:V+U,maxY:D+M}}}};function c(p){ft.call(this,t,p)}function d(p){ft.call(this,t,p)}function u(p){ft.call(this,t,p)}return t.$$set=p=>{"shape"in p&&n(0,r=p.shape),"computedStyle"in p&&n(1,i=p.computedStyle),"transform"in p&&n(2,s=p.transform),"viewportScale"in p&&n(3,a=p.viewportScale)},t.$$.update=()=>{t.$$.dirty&1&&n(4,o=r.geometry)},[r,i,s,a,o,l,c,d,u]}class Co extends nt{constructor(e){super(),et(this,e,ko,Ro,K,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}const on=new Map([[Z.RECTANGLE,Co],[Z.POLYGON,Eo]]),Po=t=>on.get(t.type),No=(t,e)=>on.set(t,e),Vo=t=>({}),Le=t=>({grab:t[0]});function Do(t){let e,n,o,r;const i=t[7].default,s=Tn(i,t,t[6],Le);return{c(){e=P("g"),s&&s.c(),f(e,"class","a9s-annotation selected")},m(a,l){L(a,e,l),s&&s.m(e,null),n=!0,o||(r=[H(e,"pointerup",t[2]),H(e,"pointermove",t[1])],o=!0)},p(a,[l]){s&&s.p&&(!n||l&64)&&On(s,i,a,a[6],n?_n(i,a[6],l,Vo):Ln(a[6]),Le)},i(a){n||(Y(s,a),n=!0)},o(a){C(s,a),n=!1},d(a){a&&O(e),s&&s.d(a),o=!1,ut(r)}}}function Uo(t,e,n){let{$$slots:o={},$$scope:r}=e;const i=St();let{shape:s}=e,{editor:a}=e,{transform:l}=e,c,d,u;const p=v=>S=>{c=v,d=l.elementToImage(S.offsetX,S.offsetY),u=s,S.target.setPointerCapture(S.pointerId),i("grab",S)},h=v=>{if(c){const[S,g]=l.elementToImage(v.offsetX,v.offsetY),$=[S-d[0],g-d[1]];n(3,s=a(u,c,$)),i("change",s)}},m=v=>{v.target.releasePointerCapture(v.pointerId),c=void 0,u=s,i("release",v)};return t.$$set=v=>{"shape"in v&&n(3,s=v.shape),"editor"in v&&n(4,a=v.editor),"transform"in v&&n(5,l=v.transform),"$$scope"in v&&n(6,r=v.$$scope)},[p,h,m,s,a,l,r,o]}class rn extends nt{constructor(e){super(),et(this,e,Uo,Do,K,{shape:3,editor:4,transform:5})}}const qt=(t,e)=>{const n=typeof e=="function"?e(t):e;if(n){const{fill:o,fillOpacity:r}=n;let i="";return o&&(i+=`fill:${o};stroke:${o};`),i+=`fill-opacity:${r||"0.25"};`,i}};function Xo(t,e,n){let o;const r=St();let{annotation:i}=e,{editor:s}=e,{style:a}=e,{target:l}=e,{transform:c}=e,{viewportScale:d}=e,u;return Ct(()=>(n(6,u=new s({target:l,props:{shape:i.target.selector,computedStyle:o,transform:c,viewportScale:d}})),u.$on("change",p=>{u.$$set({shape:p.detail}),r("change",p.detail)}),u.$on("grab",p=>r("grab",p.detail)),u.$on("release",p=>r("release",p.detail)),()=>{u.$destroy()})),t.$$set=p=>{"annotation"in p&&n(0,i=p.annotation),"editor"in p&&n(1,s=p.editor),"style"in p&&n(2,a=p.style),"target"in p&&n(3,l=p.target),"transform"in p&&n(4,c=p.transform),"viewportScale"in p&&n(5,d=p.viewportScale)},t.$$.update=()=>{t.$$.dirty&5&&(o=qt(i,a)),t.$$.dirty&65&&i&&u?.$set({shape:i.target.selector}),t.$$.dirty&80&&u&&u.$set({transform:c}),t.$$.dirty&96&&u&&u.$set({viewportScale:d})},[i,s,a,l,c,d,u]}class jo extends nt{constructor(e){super(),et(this,e,Xo,null,K,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function Go(t,e,n){const o=St();let{drawingMode:r}=e,{target:i}=e,{tool:s}=e,{transform:a}=e,{viewportScale:l}=e,c;return Ct(()=>{const d=i.closest("svg"),u=[],p=(h,m,v)=>{d?.addEventListener(h,m,v),u.push(()=>d?.removeEventListener(h,m,v))};return n(5,c=new s({target:i,props:{addEventListener:p,drawingMode:r,transform:a,viewportScale:l}})),c.$on("create",h=>o("create",h.detail)),()=>{u.forEach(h=>h()),c.$destroy()}}),t.$$set=d=>{"drawingMode"in d&&n(0,r=d.drawingMode),"target"in d&&n(1,i=d.target),"tool"in d&&n(2,s=d.tool),"transform"in d&&n(3,a=d.transform),"viewportScale"in d&&n(4,l=d.viewportScale)},t.$$.update=()=>{t.$$.dirty&40&&c&&c.$set({transform:a}),t.$$.dirty&48&&c&&c.$set({viewportScale:l})},[r,i,s,a,l,c]}class Ho extends nt{constructor(e){super(),et(this,e,Go,null,K,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function Be(t){let e,n;return{c(){e=P("rect"),n=P("rect"),f(e,"class","a9s-outer"),f(e,"x",t[1]),f(e,"y",t[2]),f(e,"width",t[3]),f(e,"height",t[4]),f(n,"class","a9s-inner"),f(n,"x",t[1]),f(n,"y",t[2]),f(n,"width",t[3]),f(n,"height",t[4])},m(o,r){L(o,e,r),L(o,n,r)},p(o,r){r&2&&f(e,"x",o[1]),r&4&&f(e,"y",o[2]),r&8&&f(e,"width",o[3]),r&16&&f(e,"height",o[4]),r&2&&f(n,"x",o[1]),r&4&&f(n,"y",o[2]),r&8&&f(n,"width",o[3]),r&16&&f(n,"height",o[4])},d(o){o&&(O(e),O(n))}}}function Fo(t){let e,n=t[0]&&Be(t);return{c(){e=P("g"),n&&n.c(),f(e,"class","a9s-annotation a9s-rubberband")},m(o,r){L(o,e,r),n&&n.m(e,null)},p(o,[r]){o[0]?n?n.p(o,r):(n=Be(o),n.c(),n.m(e,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&O(e),n&&n.d()}}}function zo(t,e,n){const o=St();let{addEventListener:r}=e,{drawingMode:i}=e,{transform:s}=e,a,l,c,d,u,p,h;const m=$=>{const y=$;a=performance.now(),i==="drag"&&(n(0,l=s.elementToImage(y.offsetX,y.offsetY)),c=l,n(1,d=l[0]),n(2,u=l[1]),n(3,p=1),n(4,h=1))},v=$=>{const y=$;l&&(c=s.elementToImage(y.offsetX,y.offsetY),n(1,d=Math.min(c[0],l[0])),n(2,u=Math.min(c[1],l[1])),n(3,p=Math.abs(c[0]-l[0])),n(4,h=Math.abs(c[1]-l[1])))},S=$=>{const y=$,w=performance.now()-a;if(i==="click"){if(w>300)return;l?g():(n(0,l=s.elementToImage(y.offsetX,y.offsetY)),c=l,n(1,d=l[0]),n(2,u=l[1]),n(3,p=1),n(4,h=1))}else l&&(w>300||p*h>100?(y.stopPropagation(),g()):(n(0,l=void 0),c=void 0))},g=()=>{if(p*h>15){const $={type:Z.RECTANGLE,geometry:{bounds:{minX:d,minY:u,maxX:d+p,maxY:u+h},x:d,y:u,w:p,h}};o("create",$)}n(0,l=void 0),c=void 0};return Ct(()=>{r("pointerdown",m),r("pointermove",v),r("pointerup",S,!0)}),t.$$set=$=>{"addEventListener"in $&&n(5,r=$.addEventListener),"drawingMode"in $&&n(6,i=$.drawingMode),"transform"in $&&n(7,s=$.transform)},[l,d,u,p,h,r,i,s]}class qo extends nt{constructor(e){super(),et(this,e,zo,Fo,K,{addEventListener:5,drawingMode:6,transform:7})}}function oe(t){const e=t.slice(),n=(e[2]?e[0]:[...e[0],e[1]]).map(o=>o.join(",")).join(" ");return e[16]=n,e}function Ye(t){let e,n,o,r,i,s=t[2]&&Me(t);return{c(){e=P("polygon"),o=P("polygon"),s&&s.c(),i=st(),f(e,"class","a9s-outer"),f(e,"points",n=t[16]),f(o,"class","a9s-inner"),f(o,"points",r=t[16])},m(a,l){L(a,e,l),L(a,o,l),s&&s.m(a,l),L(a,i,l)},p(a,l){l&7&&n!==(n=a[16])&&f(e,"points",n),l&7&&r!==(r=a[16])&&f(o,"points",r),a[2]?s?s.p(a,l):(s=Me(a),s.c(),s.m(i.parentNode,i)):s&&(s.d(1),s=null)},d(a){a&&(O(e),O(o),O(i)),s&&s.d(a)}}}function Me(t){let e,n,o;return{c(){e=P("rect"),f(e,"class","a9s-corner-handle"),f(e,"x",n=t[0][0][0]-t[3]/2),f(e,"y",o=t[0][0][1]-t[3]/2),f(e,"height",t[3]),f(e,"width",t[3])},m(r,i){L(r,e,i)},p(r,i){i&9&&n!==(n=r[0][0][0]-r[3]/2)&&f(e,"x",n),i&9&&o!==(o=r[0][0][1]-r[3]/2)&&f(e,"y",o),i&8&&f(e,"height",r[3]),i&8&&f(e,"width",r[3])},d(r){r&&O(e)}}}function Ko(t){let e,n=t[1]&&Ye(oe(t));return{c(){e=P("g"),n&&n.c(),f(e,"class","a9s-annotation a9s-rubberband")},m(o,r){L(o,e,r),n&&n.m(e,null)},p(o,[r]){o[1]?n?n.p(oe(o),r):(n=Ye(oe(o)),n.c(),n.m(e,null)):n&&(n.d(1),n=null)},i:j,o:j,d(o){o&&O(e),n&&n.d()}}}const Wo=20,Jo=1500;function Qo(t,e,n){let o;const r=St();let{addEventListener:i}=e,{drawingMode:s}=e,{transform:a}=e,{viewportScale:l=1}=e,c,d=[],u,p,h=!1;const m=y=>{const w=y,{timeStamp:k,offsetX:V,offsetY:D}=w;if(c={timeStamp:k,offsetX:V,offsetY:D},s==="drag"&&d.length===0){const U=a.elementToImage(w.offsetX,w.offsetY);d.push(U),n(1,u=U)}},v=y=>{const w=y;if(p&&clearTimeout(p),d.length>0){if(n(1,u=a.elementToImage(w.offsetX,w.offsetY)),d.length>2){const k=ne(u,d[0])*l;n(2,h=k<Wo)}w.pointerType==="touch"&&(p=setTimeout(()=>{g()},Jo))}},S=y=>{const w=y;if(p&&clearTimeout(p),s==="click"){const k=w.timeStamp-c.timeStamp,V=ne([c.offsetX,c.offsetY],[w.offsetX,w.offsetY]);if(k>300||V>15)return;if(h)$();else if(d.length===0){const D=a.elementToImage(w.offsetX,w.offsetY);d.push(D),n(1,u=D)}else d.push(u)}else{if(d.length===1&&ne(d[0],u)<=4){n(0,d=[]),n(1,u=void 0);return}w.stopImmediatePropagation(),h?$():d.push(u)}},g=()=>{if(!u)return;const y=[...d,u],w={type:Z.POLYGON,geometry:{bounds:ue(y),points:y}};de(w)>4&&(n(0,d=[]),n(1,u=void 0),r("create",w))},$=()=>{const y={type:Z.POLYGON,geometry:{bounds:ue(d),points:[...d]}};n(0,d=[]),n(1,u=void 0),r("create",y)};return Ct(()=>{i("pointerdown",m,!0),i("pointermove",v),i("pointerup",S,!0),i("dblclick",g,!0)}),t.$$set=y=>{"addEventListener"in y&&n(4,i=y.addEventListener),"drawingMode"in y&&n(5,s=y.drawingMode),"transform"in y&&n(6,a=y.transform),"viewportScale"in y&&n(7,l=y.viewportScale)},t.$$.update=()=>{t.$$.dirty&128&&n(3,o=10/l)},[d,u,h,o,i,s,a,l]}class Zo extends nt{constructor(e){super(),et(this,e,Qo,Ko,K,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}const ge=new Map([["rectangle",{tool:qo}],["polygon",{tool:Zo}]]),sn=()=>[...ge.keys()],an=t=>ge.get(t),tr=(t,e,n)=>ge.set(t,{tool:e,opts:n});function er(t){let e,n,o,r,i;return{c(){e=P("g"),n=P("ellipse"),r=P("ellipse"),f(n,"class","a9s-outer"),f(n,"style",o=t[1]?"display:none;":void 0),f(n,"cx",t[2]),f(n,"cy",t[3]),f(n,"rx",t[4]),f(n,"ry",t[5]),f(r,"class","a9s-inner"),f(r,"style",t[1]),f(r,"cx",t[2]),f(r,"cy",t[3]),f(r,"rx",t[4]),f(r,"ry",t[5]),f(e,"data-id",i=t[0].id)},m(s,a){L(s,e,a),dt(e,n),dt(e,r)},p(s,[a]){a&2&&o!==(o=s[1]?"display:none;":void 0)&&f(n,"style",o),a&2&&f(r,"style",s[1]),a&1&&i!==(i=s[0].id)&&f(e,"data-id",i)},i:j,o:j,d(s){s&&O(e)}}}function nr(t,e,n){let o,{annotation:r}=e,{geom:i}=e,{style:s}=e;const{cx:a,cy:l,rx:c,ry:d}=i;return t.$$set=u=>{"annotation"in u&&n(0,r=u.annotation),"geom"in u&&n(6,i=u.geom),"style"in u&&n(7,s=u.style)},t.$$.update=()=>{t.$$.dirty&129&&n(1,o=qt(r,s))},[r,o,a,l,c,d,i,s]}class or extends nt{constructor(e){super(),et(this,e,nr,er,K,{annotation:0,geom:6,style:7})}}function rr(t){let e,n,o,r,i;return{c(){e=P("g"),n=P("polygon"),r=P("polygon"),f(n,"class","a9s-outer"),f(n,"style",o=t[1]?"display:none;":void 0),f(n,"points",t[2].map(ir).join(" ")),f(r,"class","a9s-inner"),f(r,"style",t[1]),f(r,"points",t[2].map(sr).join(" ")),f(e,"data-id",i=t[0].id)},m(s,a){L(s,e,a),dt(e,n),dt(e,r)},p(s,[a]){a&2&&o!==(o=s[1]?"display:none;":void 0)&&f(n,"style",o),a&2&&f(r,"style",s[1]),a&1&&i!==(i=s[0].id)&&f(e,"data-id",i)},i:j,o:j,d(s){s&&O(e)}}}const ir=t=>t.join(","),sr=t=>t.join(",");function ar(t,e,n){let o,{annotation:r}=e,{geom:i}=e,{style:s}=e;const{points:a}=i;return t.$$set=l=>{"annotation"in l&&n(0,r=l.annotation),"geom"in l&&n(3,i=l.geom),"style"in l&&n(4,s=l.style)},t.$$.update=()=>{t.$$.dirty&17&&n(1,o=qt(r,s))},[r,o,a,i,s]}class lr extends nt{constructor(e){super(),et(this,e,ar,rr,K,{annotation:0,geom:3,style:4})}}function cr(t){let e,n,o,r,i;return{c(){e=P("g"),n=P("rect"),r=P("rect"),f(n,"class","a9s-outer"),f(n,"style",o=t[5]?"display:none;":void 0),f(n,"x",t[4]),f(n,"y",t[3]),f(n,"width",t[2]),f(n,"height",t[1]),f(r,"class","a9s-inner"),f(r,"style",t[5]),f(r,"x",t[4]),f(r,"y",t[3]),f(r,"width",t[2]),f(r,"height",t[1]),f(e,"data-id",i=t[0].id)},m(s,a){L(s,e,a),dt(e,n),dt(e,r)},p(s,[a]){a&32&&o!==(o=s[5]?"display:none;":void 0)&&f(n,"style",o),a&16&&f(n,"x",s[4]),a&8&&f(n,"y",s[3]),a&4&&f(n,"width",s[2]),a&2&&f(n,"height",s[1]),a&32&&f(r,"style",s[5]),a&16&&f(r,"x",s[4]),a&8&&f(r,"y",s[3]),a&4&&f(r,"width",s[2]),a&2&&f(r,"height",s[1]),a&1&&i!==(i=s[0].id)&&f(e,"data-id",i)},i:j,o:j,d(s){s&&O(e)}}}function dr(t,e,n){let o,r,i,s,a,{annotation:l}=e,{geom:c}=e,{style:d}=e;return t.$$set=u=>{"annotation"in u&&n(0,l=u.annotation),"geom"in u&&n(6,c=u.geom),"style"in u&&n(7,d=u.style)},t.$$.update=()=>{t.$$.dirty&129&&n(5,o=qt(l,d)),t.$$.dirty&64&&n(4,{x:r,y:i,w:s,h:a}=c,r,(n(3,i),n(6,c)),(n(2,s),n(6,c)),(n(1,a),n(6,c)))},[l,a,s,i,r,o,c,d]}class ur extends nt{constructor(e){super(),et(this,e,dr,cr,K,{annotation:0,geom:6,style:7})}}const fr=t=>({elementToImage:(e,n)=>{const o=t.getBoundingClientRect(),r=t.createSVGPoint();r.x=e+o.x,r.y=n+o.y;const{x:i,y:s}=r.matrixTransform(t.getScreenCTM().inverse());return[i,s]}}),hr=250,pr=(t,e)=>{const n=St();let o;return{onPointerDown:()=>o=performance.now(),onPointerUp:r=>{if(performance.now()-o<hr){const{x:i,y:s}=ln(r,t),a=e.getAt(i,s);a?n("click",{originalEvent:r,annotation:a}):n("click",{originalEvent:r})}}}},ln=(t,e)=>{const n=e.createSVGPoint(),o=e.getBoundingClientRect(),r=t.clientX-o.x,i=t.clientY-o.y,{left:s,top:a}=e.getBoundingClientRect();return n.x=r+s,n.y=i+a,n.matrixTransform(e.getScreenCTM().inverse())},{Boolean:cn}=Bn;function Ie(t,e,n){const o=t.slice();o[34]=e[n];const r=o[23](o[34].target.selector);return o[35]=r,o}function Re(t,e,n){const o=t.slice();return o[38]=e[n],o}function re(t){const e=t.slice(),n=e[38].target.selector;return e[41]=n,e}function ke(t){let e=t[38].id,n,o,r=Ce(t);return{c(){r.c(),n=st()},m(i,s){r.m(i,s),L(i,n,s),o=!0},p(i,s){s[0]&32768&&K(e,e=i[38].id)?(rt(),C(r,1,1,j),it(),r=Ce(i),r.c(),Y(r,1),r.m(n.parentNode,n)):r.p(i,s)},i(i){o||(Y(r),o=!0)},o(i){C(r),o=!1},d(i){i&&O(n),r.d(i)}}}function mr(t){let e,n;return e=new lr({props:{annotation:t[38],geom:t[41].geometry,style:t[1]}}),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,r){const i={};r[0]&32768&&(i.annotation=o[38]),r[0]&32768&&(i.geom=o[41].geometry),r[0]&2&&(i.style=o[1]),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}function gr(t){let e,n;return e=new ur({props:{annotation:t[38],geom:t[41].geometry,style:t[1]}}),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,r){const i={};r[0]&32768&&(i.annotation=o[38]),r[0]&32768&&(i.geom=o[41].geometry),r[0]&2&&(i.style=o[1]),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}function yr(t){var e;let n,o;return n=new or({props:{annotation:t[38],geom:(e=t[41])==null?void 0:e.geometry,style:t[1]}}),{c(){tt(n.$$.fragment)},m(r,i){J(n,r,i),o=!0},p(r,i){var s;const a={};i[0]&32768&&(a.annotation=r[38]),i[0]&32768&&(a.geom=(s=r[41])==null?void 0:s.geometry),i[0]&2&&(a.style=r[1]),n.$set(a)},i(r){o||(Y(n.$$.fragment,r),o=!0)},o(r){C(n.$$.fragment,r),o=!1},d(r){Q(n,r)}}}function Ce(t){let e,n,o,r;const i=[yr,gr,mr],s=[];function a(l,c){var d,u,p;return((d=l[41])==null?void 0:d.type)===Z.ELLIPSE?0:((u=l[41])==null?void 0:u.type)===Z.RECTANGLE?1:((p=l[41])==null?void 0:p.type)===Z.POLYGON?2:-1}return~(e=a(t))&&(n=s[e]=i[e](t)),{c(){n&&n.c(),o=st()},m(l,c){~e&&s[e].m(l,c),L(l,o,c),r=!0},p(l,c){let d=e;e=a(l),e===d?~e&&s[e].p(l,c):(n&&(rt(),C(s[d],1,1,()=>{s[d]=null}),it()),~e?(n=s[e],n?n.p(l,c):(n=s[e]=i[e](l),n.c()),Y(n,1),n.m(o.parentNode,o)):n=null)},i(l){r||(Y(n),r=!0)},o(l){C(n),r=!1},d(l){l&&O(o),~e&&s[e].d(l)}}}function Pe(t){let e=!t[8](t[38]),n,o,r=e&&ke(re(t));return{c(){r&&r.c(),n=st()},m(i,s){r&&r.m(i,s),L(i,n,s),o=!0},p(i,s){s[0]&33024&&(e=!i[8](i[38])),e?r?(r.p(re(i),s),s[0]&33024&&Y(r,1)):(r=ke(re(i)),r.c(),Y(r,1),r.m(n.parentNode,n)):r&&(rt(),C(r,1,1,()=>{r=null}),it())},i(i){o||(Y(r),o=!0)},o(i){C(r),o=!1},d(i){i&&O(n),r&&r.d(i)}}}function Ne(t){let e,n,o,r;const i=[wr,$r],s=[];function a(l,c){return l[7]?0:l[13]&&l[0]?1:-1}return~(e=a(t))&&(n=s[e]=i[e](t)),{c(){n&&n.c(),o=st()},m(l,c){~e&&s[e].m(l,c),L(l,o,c),r=!0},p(l,c){let d=e;e=a(l),e===d?~e&&s[e].p(l,c):(n&&(rt(),C(s[d],1,1,()=>{s[d]=null}),it()),~e?(n=s[e],n?n.p(l,c):(n=s[e]=i[e](l),n.c()),Y(n,1),n.m(o.parentNode,o)):n=null)},i(l){r||(Y(n),r=!0)},o(l){C(n),r=!1},d(l){l&&O(o),~e&&s[e].d(l)}}}function $r(t){let e=t[2],n,o,r=Ve(t);return{c(){r.c(),n=st()},m(i,s){r.m(i,s),L(i,n,s),o=!0},p(i,s){s[0]&4&&K(e,e=i[2])?(rt(),C(r,1,1,j),it(),r=Ve(i),r.c(),Y(r,1),r.m(n.parentNode,n)):r.p(i,s)},i(i){o||(Y(r),o=!0)},o(i){C(r),o=!1},d(i){i&&O(n),r.d(i)}}}function wr(t){let e,n,o=Et(t[7]),r=[];for(let s=0;s<o.length;s+=1)r[s]=Xe(Ie(t,o,s));const i=s=>C(r[s],1,1,()=>{r[s]=null});return{c(){for(let s=0;s<r.length;s+=1)r[s].c();e=st()},m(s,a){for(let l=0;l<r.length;l+=1)r[l]&&r[l].m(s,a);L(s,e,a),n=!0},p(s,a){if(a[0]&10553506){o=Et(s[7]);let l;for(l=0;l<o.length;l+=1){const c=Ie(s,o,l);r[l]?(r[l].p(c,a),Y(r[l],1)):(r[l]=Xe(c),r[l].c(),Y(r[l],1),r[l].m(e.parentNode,e))}for(rt(),l=o.length;l<r.length;l+=1)i(l);it()}},i(s){if(!n){for(let a=0;a<o.length;a+=1)Y(r[a]);n=!0}},o(s){r=r.filter(cn);for(let a=0;a<r.length;a+=1)C(r[a]);n=!1},d(s){s&&O(e),fe(r,s)}}}function Ve(t){let e,n;return e=new Ho({props:{target:t[5],tool:t[13],drawingMode:t[12],transform:t[11],viewportScale:t[16]}}),e.$on("create",t[20]),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,r){const i={};r[0]&32&&(i.target=o[5]),r[0]&8192&&(i.tool=o[13]),r[0]&4096&&(i.drawingMode=o[12]),r[0]&2048&&(i.transform=o[11]),r[0]&65536&&(i.viewportScale=o[16]),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}function De(t){let e=t[34].id,n,o,r=Ue(t);return{c(){r.c(),n=st()},m(i,s){r.m(i,s),L(i,n,s),o=!0},p(i,s){s[0]&128&&K(e,e=i[34].id)?(rt(),C(r,1,1,j),it(),r=Ue(i),r.c(),Y(r,1),r.m(n.parentNode,n)):r.p(i,s)},i(i){o||(Y(r),o=!0)},o(i){C(r),o=!1},d(i){i&&O(n),r.d(i)}}}function Ue(t){let e,n;return e=new jo({props:{target:t[5],editor:t[23](t[34].target.selector),annotation:t[34],style:t[1],transform:t[11],viewportScale:t[16]}}),e.$on("change",function(){F(t[21](t[34]))&&t[21](t[34]).apply(this,arguments)}),{c(){tt(e.$$.fragment)},m(o,r){J(e,o,r),n=!0},p(o,r){t=o;const i={};r[0]&32&&(i.target=t[5]),r[0]&128&&(i.editor=t[23](t[34].target.selector)),r[0]&128&&(i.annotation=t[34]),r[0]&2&&(i.style=t[1]),r[0]&2048&&(i.transform=t[11]),r[0]&65536&&(i.viewportScale=t[16]),e.$set(i)},i(o){n||(Y(e.$$.fragment,o),n=!0)},o(o){C(e.$$.fragment,o),n=!1},d(o){Q(e,o)}}}function Xe(t){let e,n,o=t[35]&&De(t);return{c(){o&&o.c(),e=st()},m(r,i){o&&o.m(r,i),L(r,e,i),n=!0},p(r,i){r[35]?o?(o.p(r,i),i[0]&128&&Y(o,1)):(o=De(r),o.c(),Y(o,1),o.m(e.parentNode,e)):o&&(rt(),C(o,1,1,()=>{o=null}),it())},i(r){n||(Y(o),n=!0)},o(r){C(o),n=!1},d(r){r&&O(e),o&&o.d(r)}}}function vr(t){let e,n,o,r,i,s,a=Et(t[15]),l=[];for(let u=0;u<a.length;u+=1)l[u]=Pe(Re(t,a,u));const c=u=>C(l[u],1,1,()=>{l[u]=null});let d=t[5]&&Ne(t);return{c(){e=P("svg"),n=P("g");for(let u=0;u<l.length;u+=1)l[u].c();o=P("g"),d&&d.c(),f(o,"class","drawing"),f(e,"class","a9s-annotationlayer"),ht(e,"drawing",t[13]),ht(e,"hidden",!t[3]),ht(e,"hover",t[14])},m(u,p){L(u,e,p),dt(e,n);for(let h=0;h<l.length;h+=1)l[h]&&l[h].m(n,null);dt(e,o),d&&d.m(o,null),t[30](o),t[31](e),r=!0,i||(s=[H(e,"pointerup",function(){F(t[9])&&t[9].apply(this,arguments)}),H(e,"pointerdown",function(){F(t[10])&&t[10].apply(this,arguments)}),H(e,"pointermove",t[22])],i=!0)},p(u,p){if(t=u,p[0]&33026){a=Et(t[15]);let h;for(h=0;h<a.length;h+=1){const m=Re(t,a,h);l[h]?(l[h].p(m,p),Y(l[h],1)):(l[h]=Pe(m),l[h].c(),Y(l[h],1),l[h].m(n,null))}for(rt(),h=a.length;h<l.length;h+=1)c(h);it()}t[5]?d?(d.p(t,p),p[0]&32&&Y(d,1)):(d=Ne(t),d.c(),Y(d,1),d.m(o,null)):d&&(rt(),C(d,1,1,()=>{d=null}),it()),(!r||p[0]&8192)&&ht(e,"drawing",t[13]),(!r||p[0]&8)&&ht(e,"hidden",!t[3]),(!r||p[0]&16384)&&ht(e,"hover",t[14])},i(u){if(!r){for(let p=0;p<a.length;p+=1)Y(l[p]);Y(d),r=!0}},o(u){l=l.filter(cn);for(let p=0;p<l.length;p+=1)C(l[p]);C(d),r=!1},d(u){u&&O(e),fe(l,u),d&&d.d(),t[30](null),t[31](null),i=!1,ut(s)}}}function br(t,e,n){let o,r,i,s,a,l,c,d,u,p,h,m=j,v=()=>(m(),m=We(b,_=>n(16,h=_)),b);t.$$.on_destroy.push(()=>m());let{drawingEnabled:S}=e,{image:g}=e,{preferredDrawingMode:$}=e,{state:y}=e,{style:w=void 0}=e,{toolName:k=sn()[0]}=e,{user:V}=e,{visible:D=!0}=e,U,M,b;Ct(()=>v(n(6,b=_o(g,M))));const{hover:x,selection:A,store:E}=y;Wt(t,x,_=>n(14,d=_)),Wt(t,A,_=>n(29,u=_)),Wt(t,E,_=>n(15,p=_));let I,N;const W=_=>{I&&E.unobserve(I);const G=_.filter(({editable:B})=>B).map(({id:B})=>B);G.length>0?(n(7,N=G.map(B=>E.getAnnotation(B)).filter(Boolean)),I=B=>{const{updated:q}=B.changes;n(7,N=q?.map(gt=>gt.newValue))},E.observe(I,{annotations:G})):n(7,N=void 0)},Tt=_=>{const G=zn(),B={id:G,bodies:[],target:{annotation:G,selector:_.detail,creator:V,created:new Date}};E.addAnnotation(B),A.setSelected(B.id)},at=_=>G=>{var B;const{target:q}=_,gt=10*60*1e3,R=((B=q.creator)==null?void 0:B.id)!==V.id||!q.created||new Date().getTime()-q.created.getTime()>gt;E.updateTarget({...q,selector:G.detail,created:R?q.created:new Date,updated:R?new Date:void 0,updatedBy:R?V:void 0})},_t=_=>{const{x:G,y:B}=ln(_,M),q=E.getAt(G,B);q?d!==q.id&&x.set(q.id):x.set(void 0)},lt=_=>Po(_);function Ot(_){Ft[_?"unshift":"push"](()=>{U=_,n(5,U)})}function ct(_){Ft[_?"unshift":"push"](()=>{M=_,n(4,M)})}return t.$$set=_=>{"drawingEnabled"in _&&n(0,S=_.drawingEnabled),"image"in _&&n(24,g=_.image),"preferredDrawingMode"in _&&n(25,$=_.preferredDrawingMode),"state"in _&&n(26,y=_.state),"style"in _&&n(1,w=_.style),"toolName"in _&&n(2,k=_.toolName),"user"in _&&n(27,V=_.user),"visible"in _&&n(3,D=_.visible)},t.$$.update=()=>{t.$$.dirty[0]&4&&n(13,{tool:o,opts:r}=an(k)||{tool:void 0,opts:void 0},o,(n(28,r),n(2,k))),t.$$.dirty[0]&301989888&&n(12,i=r?.drawingMode||$),t.$$.dirty[0]&16&&n(11,s=fr(M)),t.$$.dirty[0]&16&&n(10,{onPointerDown:a,onPointerUp:l}=pr(M,E),a,(n(9,l),n(4,M))),t.$$.dirty[0]&536870912&&n(8,c=_=>u.selected.find(G=>G.id===_.id&&G.editable)),t.$$.dirty[0]&536870912&&W(u.selected)},[S,w,k,D,M,U,b,N,c,l,a,s,i,o,d,p,h,x,A,E,Tt,at,_t,lt,g,$,y,V,r,u,Ot,ct]}class xr extends nt{constructor(e){super(),et(this,e,br,vr,K,{drawingEnabled:0,image:24,preferredDrawingMode:25,state:26,style:1,toolName:2,user:27,visible:3},null,[-1,-1])}}function Ar(t,e,n,o,r){dn(t,e,n||0,o||t.length-1,r||Er)}function dn(t,e,n,o,r){for(;o>n;){if(o-n>600){var i=o-n+1,s=e-n+1,a=Math.log(i),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(i-l)/i)*(s-i/2<0?-1:1),d=Math.max(n,Math.floor(e-s*l/i+c)),u=Math.min(o,Math.floor(e+(i-s)*l/i+c));dn(t,e,d,u,r)}var p=t[e],h=n,m=o;for(Bt(t,n,e),r(t[o],p)>0&&Bt(t,n,o);h<m;){for(Bt(t,h,m),h++,m--;r(t[h],p)<0;)h++;for(;r(t[m],p)>0;)m--}r(t[n],p)===0?Bt(t,n,m):(m++,Bt(t,m,o)),m<=e&&(n=m+1),e<=m&&(o=m-1)}}function Bt(t,e,n){var o=t[e];t[e]=t[n],t[n]=o}function Er(t,e){return t<e?-1:t>e?1:0}class Sr{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let n=this.data;const o=[];if(!jt(e,n))return o;const r=this.toBBox,i=[];for(;n;){for(let s=0;s<n.children.length;s++){const a=n.children[s],l=n.leaf?r(a):a;jt(e,l)&&(n.leaf?o.push(a):se(e,l)?this._all(a,o):i.push(a))}n=i.pop()}return o}collides(e){let n=this.data;if(!jt(e,n))return!1;const o=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],s=n.leaf?this.toBBox(i):i;if(jt(e,s)){if(n.leaf||se(e,s))return!0;o.push(i)}}n=o.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let o=0;o<e.length;o++)this.insert(e[o]);return this}let n=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=xt([]),this}remove(e,n){if(!e)return this;let o=this.data;const r=this.toBBox(e),i=[],s=[];let a,l,c;for(;o||i.length;){if(o||(o=i.pop(),l=i[i.length-1],a=s.pop(),c=!0),o.leaf){const d=Tr(e,o.children,n);if(d!==-1)return o.children.splice(d,1),i.push(o),this._condense(i),this}!c&&!o.leaf&&se(o,r)?(i.push(o),s.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],c=!1):o=null}return this}toBBox(e){return e}compareMinX(e,n){return e.minX-n.minX}compareMinY(e,n){return e.minY-n.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,n){const o=[];for(;e;)e.leaf?n.push(...e.children):o.push(...e.children),e=o.pop();return n}_build(e,n,o,r){const i=o-n+1;let s=this._maxEntries,a;if(i<=s)return a=xt(e.slice(n,o+1)),vt(a,this.toBBox),a;r||(r=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,r-1))),a=xt([]),a.leaf=!1,a.height=r;const l=Math.ceil(i/s),c=l*Math.ceil(Math.sqrt(s));je(e,n,o,c,this.compareMinX);for(let d=n;d<=o;d+=c){const u=Math.min(d+c-1,o);je(e,d,u,l,this.compareMinY);for(let p=d;p<=u;p+=l){const h=Math.min(p+l-1,u);a.children.push(this._build(e,p,h,r-1))}}return vt(a,this.toBBox),a}_chooseSubtree(e,n,o,r){for(;r.push(n),!(n.leaf||r.length-1===o);){let i=1/0,s=1/0,a;for(let l=0;l<n.children.length;l++){const c=n.children[l],d=ie(c),u=Lr(e,c)-d;u<s?(s=u,i=d<i?d:i,a=c):u===s&&d<i&&(i=d,a=c)}n=a||n.children[0]}return n}_insert(e,n,o){const r=o?e:this.toBBox(e),i=[],s=this._chooseSubtree(r,this.data,n,i);for(s.children.push(e),It(s,r);n>=0&&i[n].children.length>this._maxEntries;)this._split(i,n),n--;this._adjustParentBBoxes(r,i,n)}_split(e,n){const o=e[n],r=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,r);const s=this._chooseSplitIndex(o,i,r),a=xt(o.children.splice(s,o.children.length-s));a.height=o.height,a.leaf=o.leaf,vt(o,this.toBBox),vt(a,this.toBBox),n?e[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(e,n){this.data=xt([e,n]),this.data.height=e.height+1,this.data.leaf=!1,vt(this.data,this.toBBox)}_chooseSplitIndex(e,n,o){let r,i=1/0,s=1/0;for(let a=n;a<=o-n;a++){const l=Mt(e,0,a,this.toBBox),c=Mt(e,a,o,this.toBBox),d=Br(l,c),u=ie(l)+ie(c);d<i?(i=d,r=a,s=u<s?u:s):d===i&&u<s&&(s=u,r=a)}return r||o-n}_chooseSplitAxis(e,n,o){const r=e.leaf?this.compareMinX:_r,i=e.leaf?this.compareMinY:Or,s=this._allDistMargin(e,n,o,r),a=this._allDistMargin(e,n,o,i);s<a&&e.children.sort(r)}_allDistMargin(e,n,o,r){e.children.sort(r);const i=this.toBBox,s=Mt(e,0,n,i),a=Mt(e,o-n,o,i);let l=Xt(s)+Xt(a);for(let c=n;c<o-n;c++){const d=e.children[c];It(s,e.leaf?i(d):d),l+=Xt(s)}for(let c=o-n-1;c>=n;c--){const d=e.children[c];It(a,e.leaf?i(d):d),l+=Xt(a)}return l}_adjustParentBBoxes(e,n,o){for(let r=o;r>=0;r--)It(n[r],e)}_condense(e){for(let n=e.length-1,o;n>=0;n--)e[n].children.length===0?n>0?(o=e[n-1].children,o.splice(o.indexOf(e[n]),1)):this.clear():vt(e[n],this.toBBox)}}function Tr(t,e,n){if(!n)return e.indexOf(t);for(let o=0;o<e.length;o++)if(n(t,e[o]))return o;return-1}function vt(t,e){Mt(t,0,t.children.length,e,t)}function Mt(t,e,n,o,r){r||(r=xt(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let i=e;i<n;i++){const s=t.children[i];It(r,t.leaf?o(s):s)}return r}function It(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function _r(t,e){return t.minX-e.minX}function Or(t,e){return t.minY-e.minY}function ie(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function Xt(t){return t.maxX-t.minX+(t.maxY-t.minY)}function Lr(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function Br(t,e){const n=Math.max(t.minX,e.minX),o=Math.max(t.minY,e.minY),r=Math.min(t.maxX,e.maxX),i=Math.min(t.maxY,e.maxY);return Math.max(0,r-n)*Math.max(0,i-o)}function se(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function jt(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function xt(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function je(t,e,n,o,r){const i=[e,n];for(;i.length;){if(n=i.pop(),e=i.pop(),n-e<=o)continue;const s=e+Math.ceil((n-e)/o/2)*o;Ar(t,s,e,n,r),i.push(e,s,s,n)}}const Yr=()=>{const t=new Sr,e=new Map,n=()=>[...e.values()],o=()=>{t.clear(),e.clear()},r=s=>{const{minX:a,minY:l,maxX:c,maxY:d}=s.selector.geometry.bounds,u={minX:a,minY:l,maxX:c,maxY:d,target:s};t.insert(u),e.set(s.annotation,u)},i=s=>{const a=e.get(s.annotation);a&&t.remove(a),e.delete(s.annotation)};return{all:n,clear:o,getAt:(s,a)=>{const l=t.search({minX:s,minY:a,maxX:s,maxY:a}).map(c=>c.target).filter(c=>c.selector.type===Z.RECTANGLE||Vn(c.selector,s,a));if(l.length>0)return l.sort((c,d)=>de(c.selector)-de(d.selector)),l[0]},getIntersecting:(s,a,l,c)=>t.search({minX:s,minY:a,maxX:s+l,maxY:a+c}).map(d=>d.target),insert:r,remove:i,set:(s,a=!0)=>{a&&o();const l=s.reduce((c,d)=>{var u,p;if((p=(u=d.selector)==null?void 0:u.geometry)!=null&&p.bounds){const{minX:h,minY:m,maxX:v,maxY:S}=d.selector.geometry.bounds;return[...c,{minX:h,minY:m,maxX:v,maxY:S,target:d}]}else return c},[]);l.forEach(c=>e.set(c.target.annotation,c)),t.load(l)},size:()=>t.all().length,update:(s,a)=>{i(s),r(a)}}},Mr=t=>{const e=io(),n=Yr(),o=Wn(e,t.userSelectAction),r=Kn(e),i=uo();return e.observe(({changes:s})=>{n.set((s.created||[]).map(a=>a.target),!1),(s.deleted||[]).forEach(a=>n.remove(a.target)),(s.updated||[]).forEach(({oldValue:a,newValue:l})=>n.update(a.target,l.target))}),{store:{...e,getAt:(s,a)=>{const l=n.getAt(s,a);return l?e.getAnnotation(l.annotation):void 0},getIntersecting:(s,a,l,c)=>n.getIntersecting(s,a,l,c).map(d=>e.getAnnotation(d.annotation))},selection:o,hover:r,viewport:i}},Ir=t=>{const e=Mr(t);return{...e,store:so(e.store)}},Rr=t=>{let e,n;if(t.nodeName==="CANVAS")e=t,n=e.getContext("2d",{willReadFrequently:!0});else{const r=t;e=document.createElement("canvas"),e.width=r.width,e.height=r.height,n=e.getContext("2d",{willReadFrequently:!0}),n.drawImage(r,0,0,r.width,r.height)}let o=0;for(let r=1;r<10;r++)for(let i=1;i<10;i++){const s=Math.round(i*e.width/10),a=Math.round(r*e.height/10),l=n.getImageData(s,a,1,1).data,c=(.299*l[0]+.587*l[1]+.114*l[2])/255;o+=c}return o/81},kr=t=>{const e=Rr(t),n=e>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${e.toFixed(1)}. Setting ${n} theme.`),n},Ge=(t,e,n)=>e.setAttribute("data-theme",n==="auto"?kr(t):n),Cr=(t,e)=>({...t,drawingEnabled:t.drawingEnabled===void 0?e.drawingEnabled:t.drawingEnabled,drawingMode:t.drawingMode||e.drawingMode,userSelectAction:t.userSelectAction||e.userSelectAction,theme:t.theme||e.theme}),He=navigator.userAgent.indexOf("Mac OS X")!==-1,Pr=(t,e)=>{const n=document,o=s=>{const a=s;a.key==="z"&&a.ctrlKey?t.undo():a.key==="y"&&a.ctrlKey&&t.redo()},r=s=>{const a=s;a.key==="z"&&a.metaKey&&(a.shiftKey?t.redo():t.undo())},i=()=>{He?n.removeEventListener("keydown",r):n.removeEventListener("keydown",o)};return He?n.addEventListener("keydown",r):n.addEventListener("keydown",o),{destroy:i}},Ur=(t,e={})=>{if(!t)throw"Missing argument: image";const n=typeof t=="string"?document.getElementById(t):t,o=Cr(e,{drawingEnabled:!0,drawingMode:"drag",userSelectAction:en.EDIT,theme:"light"}),r=Ir(o),{selection:i,store:s}=r,a=co(s),l=fo(r,a,o.adapter,o.autoSave),c=document.createElement("DIV");c.style.position="relative",c.style.display="inline-block",n.style.display="block",n.parentNode.insertBefore(c,n),c.appendChild(n);const d=Pr(a);let u=vo();Ge(n,c,o.theme);const p=new xr({target:c,props:{drawingEnabled:!!o.drawingEnabled,image:n,preferredDrawingMode:o.drawingMode,state:r,style:o.style,user:u}});p.$on("click",M=>{const{originalEvent:b,annotation:x}=M.detail;x?i.userSelect(x.id,b):i.isEmpty()||i.clear()});const h=po(r,a,o.adapter),m=()=>{p.$destroy(),c.parentNode.insertBefore(n,c),c.parentNode.removeChild(c),d.destroy(),a.destroy()},v=()=>u,S=(M,b,x)=>tr(M,b,x),g=(M,b)=>No(M,b),$=M=>{if(!an(M))throw`No drawing tool named ${M}`;p.$set({toolName:M})},y=M=>p.$set({drawingEnabled:M}),w=M=>{console.warn("Filter not implemented yet")},k=M=>p.$set({style:M}),V=M=>Ge(n,c,M),D=M=>{u=M,p.$set({user:M})},U=M=>p.$set({visible:M});return{...h,destroy:m,getUser:v,listDrawingTools:sn,on:l.on,off:l.off,registerDrawingTool:S,registerShapeEditor:g,setDrawingEnabled:y,setDrawingTool:$,setFilter:w,setStyle:k,setTheme:V,setUser:D,setVisible:U,element:c,state:r}};export{Ur as R,Vr as j,Dr as m,Z as q};
